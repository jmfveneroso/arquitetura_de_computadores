//							Iuri Silva Castro
//			Mestrando em Engenharia Eletrica - PPGEE
//			Universidade Federal de Minas Gerais - UFMG
//									2º/2017


/*		Modulo DE2-115

	- 

*/


/*
		Modulo para o teste da ULA com o Banco de Registradores
*/

/* Instruçao generica:	INS OPC, OPA, OPB		(16-bit)
								OPC = OPA (op) OPB
			- 4-bit:	CODOp (Operaçao a ser feita)
			- 4-bit: OPA 	(Endereço do RegA)
			- 4-bit: OPB 	(Endereço do RegB ou Imediato)
			- 4-bit: OPC 	(Endereço do registrador de destino)
*/

/* OpB pode ser tanto o endereço do registrador B como o imediato
	
*/
module TesteULA (Instr, CLK, RST, DONE);
	
	input CLK, RST;
	input [15:0] Instr;
	output reg DONE;
	
	wire [15:0] res, regA, regB, outMux;
	wire isImm;
	wire [3:0] opA, opB, opC, opALU;
	
	reg [1:0] state;
	reg wen;
	
	parameter S0 = 2'b00, S1 = 2'b01, S2 = 2'b10, S3 = 2'b11;
	
	Decoder instdecode(Instr, isImm, opALU, opA, opB, opC, CLK);
	Mux16bit2x1 muxOpImm(regB, { 12'h000, opB }, outMux, isImm);
	RegisterBank regBank(opA, opB, opC, res, wen, CLK, RST, regA, regB);
	ULA modULA(regA, outMux, res, opALU, CLK);
	
	always @(posedge CLK) begin
		if ( RST ) begin
			state = 2'b00;
			DONE = 0;
		end
		else begin
			case (state)
				S0:	// Decodificaçao de instruçao
				begin
					DONE = 0;	// 
					wen = 0;		// Leitura no banco
					state = S1;
				end
				S1:	// Busca de valores nos registradores
				begin
					DONE = 0;
					wen = 0;		// Leitura no banco
					state = S2;
				end
				S2: 	// Execuçao 
				begin
					DONE = 0;
					wen = 0;		// Leitura no banco
					state = S3;
				end
				S3: 	// Write Back 
				begin
					DONE = 1;
					wen = 1;		// Escrita no banco
					state = S0;
				end
				default: begin
					state = S0;
				end
			endcase
		end
	end	
endmodule
